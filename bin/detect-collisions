#!/usr/bin/env php
<?php declare(strict_types=1);

use ShipMonk\FileParsingException;
use ShipMonk\InvalidPathProvidedException;
use ShipMonk\NameCollisionDetector;

$autoloadFiles = [
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/../../../autoload.php',
];

foreach ($autoloadFiles as $autoloadFile) {
    if (file_exists($autoloadFile)) {
        require_once $autoloadFile;
        break;
    }
}

$cwd = getcwd();
$directories = array_map(static function ($arg) use ($cwd) {
    return $cwd . '/' . $arg;
}, array_slice($argv, 1));

if ($directories === []) {
    echo "ERROR: no directories provided, use e.g. `detect-collisions src tests`\n";
    exit(255);
}

try {
    $detector = new NameCollisionDetector($directories, $cwd);
    $collisions = $detector->getCollidingTypes();

} catch (InvalidPathProvidedException | FileParsingException $e) {
    echo "ERROR: {$e->getMessage()}\n";
    exit(255);
}

foreach ($collisions as $name => $filePaths) {
    $count = count($filePaths);
    echo "$name is defined $count times:\n";
    foreach ($filePaths as $filePath) {
        echo " > $filePath\n";
    }
    echo "\n";
}

if ($collisions === []) {
    echo "OK: no name collision found in: " . implode(', ', $directories) . "\n";
}

exit(count($collisions) > 0 ? 1 : 0);
